version: "3.8"

services:
  ingress-proxy:
    container_name: dissolution-ingress-proxy
    image: traefik:v2.2
    command: --api.insecure=true --providers.docker
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock # So that Traefik can listen to the Docker events
    networks:
      - chs-dev
    ports:
      - 80:80
      - 8080:8080 # Web UI (enabled by --api.insecure=true)
  dissolution-web:
    build: .
    image: dissolution-web:1.0
    labels:
      - traefik.http.routers.dissolution-web.rule=Host(`chs-dev`) && PathPrefix(`/dissolution-web/`)
    ports:
      - 3000:3000
    networks:
      - chs-dev
    working_dir: /app
    environment:
      - CDN_HOST=cdn.chs-dev
      - CACHE_SERVER=0.0.0.0:6379
      - CACHE_DB=0
      - CACHE_PASSWORD=''

      - COOKIE_NAME=SID
      - COOKIE_DOMAIN=chs-dev.internal
      - COOKIE_SECURE_ONLY=0
      - COOKIE_SECRET=ChGovUk-XQrbf3sLj2abFxIY2TlapsJ
      - DEFAULT_SESSION_EXPIRATION=3600

      - LOG_LEVEL=info
      - HUMAN_LOG=1
  cdn-ch-gov-uk:
    container_name: chs-cdn-ch-gov-uk
    image: 169942020521.dkr.ecr.eu-west-1.amazonaws.com/local/cdn.ch.gov.uk:latest
    labels:
      - traefik.http.routers.cdn-ch-gov-uk.rule=Host(`cdn.chs-dev`)
    networks:
      - chs-dev
    expose:
      - 80
  account-ch-gov-uk:
    image: 169942020521.dkr.ecr.eu-west-1.amazonaws.com/local/account.ch.gov.uk:latest
    labels:
      - traefik.http.routers.account-ch-gov-uk.rule=Host(`account.chs-dev`)
    environment:
      - ACCOUNT_CH_CLIENT_ID=${OAUTH2_CLIENT_ID}
      - ACCOUNT_CH_CLIENT_SECRET=${OAUTH2_CLIENT_SECRET}
      - ACCOUNT_OAUTH2_REQUEST_KEY=${OAUTH2_REQUEST_KEY}
      - ACCOUNT_OAUTH2_TOKEN_KEY=${OAUTH2_TOKEN_KEY}
      - ACCOUNT_URL=http://account.chs-dev
      - API_LOCAL_URL=http://localhost?API_LOCAL_URL
      - CACHE_SERVER=redis:6379
      - CDN_HOST=cdn.chs-dev
      - CHS_API_KEY
      - CHS_BACKEND_URL=http://localhost?CHS_BACKEND_URL
      - CHS_KAFKA_API_LOCAL_URL=http://localhost?CHS_KAFKA_API_LOCAL_URL
      - CHS_MONITOR_API_LOCAL_URL=http://localhost?CHS_MONITOR_API_LOCAL_URL
      - CHS_MONITOR_GUI_URL=http://localhost?CHS_MONITOR_GUI_URL
      - CHS_URL=http://localhost?CHS_URL
      - COOKIE_DOMAIN=chs-dev
      - COOKIE_SECRET
      - DISABLE_FOLLOW=0
      - DOCUMENT_API_LOCAL_URL=http://localhost?DOCUMENT_API_LOCAL_URL
      - MONGODB_URL=mongodb://mongo
      - PIWIK_URL=
      - PIWIK_SITE_ID=
      - PIWIK_EMBED=
      - QUEUE_API_LOCAL_URL=http://localhost?QUEUE_API_LOCAL_URL
      - STATSD_HOST=localhost
      - STATSD_PORT=8125
      - URL_SIGNING_SALT
    networks:
      - chs-dev
    expose:
      - 4000

networks:
  chs-dev: {}